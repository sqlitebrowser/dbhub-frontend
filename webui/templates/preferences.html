[[ define "prefPage" ]]
<!doctype html>
<html ng-app="DBHub" ng-controller="prefView">
[[ template "head" . ]]
<body>
[[ template "header" . ]]
<div style="margin-left: 2%; margin-right: 2%; padding-left: 2%; padding-right: 2%;">
    <div class="row">
        <div class="col-md-1">
            &nbsp;
        </div>
        <div class="col-md-10">
            <h2 style="text-align: center;">Settings</h2>
            <h3 style="text-align: center;">Used when uploading databases</h3>
            <form action="/pref" method="post">
                <table class="table table-striped table-responsive settingsTable">
                    <tr>
                        <th width="25%">Full Name</th>
                        <td><input name="fullname" style="width: 100%;" value="{{ FullName }}" ng-attr-placeholder="{{ NamePlaceholder }}" maxlength="80"></td>
                    </tr>
                    <tr>
                        <th>Email address</th>
                        <td><input name="email" style="width: 100%;" value="{{ EmailAddr }}" ng-attr-placeholder="{{ EmailPlaceholder }}" maxlength="80"><br />
                            <i>If you don't want to use your real email address, use
                                "[[ .Meta.LoggedInUser ]]@[[ .Meta.Server ]]".</i></td>
                    </tr>
                </table>
                <h3 style="text-align: center;">Display options</h3>
                <table class="table table-striped table-responsive settingsTable" style="margin-bottom: 20px;">
                    <tr>
                        <th>Maximum number of database rows to display</th>
                        <td><input type="number" name="maxrows" value="[[ .MaxRows ]]" min="1" max="500"></td>
                    </tr>
                    <tr>
                        <td style="border-left: none;" colspan="2">
                            <div style="text-align: center;">
                                <input type="submit" class="btn btn-primary" value="Update">
                            </div>
                        </td>
                    </tr>
                </table>
            </form>

            <h3 style="text-align: center;"><a href="https://api.dbhub.io" target="_blank">API keys</a></h3>
            <div style="text-align: center; font-style: italic; font-size: large;">(In early development, but you're welcome to use it.)</div>
            <table class="table table-striped table-responsive settingsTable" style="margin-bottom: 20px;">
                <tr>
                    <th>Key</th>
                    <th>Generation date</th>
                    <th>Database(s)</th>
                    <th>Allowed function calls</th>
                </tr>
                <tr ng-repeat="api in apiKeys">
                    <td><p style="font-family: monospace, monospace; text-align: center;">{{ api.key }}</p>
                        <div style="text-align: center;">
                            <input type="submit" class="btn btn-primary" value="Revoke" ng-click="apiKeyRevoke(api.key)">
                        </div>
                    </td>
                    <td>{{ api.date_created | date : 'medium' }}</td>
                    <td>
                        <div class="btn-group" uib-dropdown keyboard-nav="true">
                            <button id="viewtable" type="button" class="btn">{{ api.database_name }}</button>

                            <button type="button" uib-dropdown-toggle class="btn btn-default">
                                <span class="caret"></span>
                            </button>
                            <ul uib-dropdown-menu class="dropdown-menu" role="menu">
                                <li role="menuitem" ng-click="allDBs(api.key)">
                                    <a href="">All databases</a>
                                </li>
                                <li class="divider"></li>
                                <li ng-repeat="database in dbList | orderBy" role="menuitem" ng-click="selectDB(api.key, database)">
                                    <a href="">{{ database }}</a>
                                </li>
                            </ul>
                        </div>
                    </td>
                    <td>
                        <table class="table table-striped table-responsive settingsTable">
                            <tr>
                                <th>Branches()</th>
                                <td>
                                    <div class="btn-group">
                                        <label class="btn btn-default" ng-model="api.permissions.branches" ng-click="apiPermUpdate(api.key, 'branches', true)" uib-btn-radio="true">Yes</label>
                                        <label class="btn btn-default" ng-model="api.permissions.branches" ng-click="apiPermUpdate(api.key, 'branches', false)" uib-btn-radio="false">No</label>
                                    </div>
                                </td>
                                <th>Metadata()</th>
                                <td>
                                    <div class="btn-group">
                                        <label class="btn btn-default" ng-model="api.permissions.metadata" ng-click="apiPermUpdate(api.key, 'metadata', true)" uib-btn-radio="true">Yes</label>
                                        <label class="btn btn-default" ng-model="api.permissions.metadata" ng-click="apiPermUpdate(api.key, 'metadata', false)" uib-btn-radio="false">No</label>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <th>Columns()</th>
                                <td>
                                    <div class="btn-group">
                                        <label class="btn btn-default" ng-model="api.permissions.columns" ng-click="apiPermUpdate(api.key, 'columns', true)" uib-btn-radio="true">Yes</label>
                                        <label class="btn btn-default" ng-model="api.permissions.columns" ng-click="apiPermUpdate(api.key, 'columns', false)" uib-btn-radio="false">No</label>
                                    </div>
                                </td>
                                <th>Query()</th>
                                <td>
                                    <div class="btn-group">
                                        <label class="btn btn-default" ng-model="api.permissions.query" ng-click="apiPermUpdate(api.key, 'query', true)" uib-btn-radio="true">Yes</label>
                                        <label class="btn btn-default" ng-model="api.permissions.query" ng-click="apiPermUpdate(api.key, 'query', false)" uib-btn-radio="false">No</label>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <th>Commits()</th>
                                <td>
                                    <div class="btn-group">
                                        <label class="btn btn-default" ng-model="api.permissions.commits" ng-click="apiPermUpdate(api.key, 'commits', true)" uib-btn-radio="true">Yes</label>
                                        <label class="btn btn-default" ng-model="api.permissions.commits" ng-click="apiPermUpdate(api.key, 'commits', false)" uib-btn-radio="false">No</label>
                                    </div>
                                </td>
                                <th>Releases()</th>
                                <td>
                                    <div class="btn-group">
                                        <label class="btn btn-default" ng-model="api.permissions.releases" ng-click="apiPermUpdate(api.key, 'releases', true)" uib-btn-radio="true">Yes</label>
                                        <label class="btn btn-default" ng-model="api.permissions.releases" ng-click="apiPermUpdate(api.key, 'releases', false)" uib-btn-radio="false">No</label>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <th>Databases()</th>
                                <td>
                                    <div class="btn-group">
                                        <label class="btn btn-default" ng-model="api.permissions.databases" ng-click="apiPermUpdate(api.key, 'databases', true)" uib-btn-radio="true">Yes</label>
                                        <label class="btn btn-default" ng-model="api.permissions.databases" ng-click="apiPermUpdate(api.key, 'databases', false)" uib-btn-radio="false">No</label>
                                    </div>
                                </td>
                                <th>Tables()</th>
                                <td>
                                    <div class="btn-group">
                                        <label class="btn btn-default" ng-model="api.permissions.tables" ng-click="apiPermUpdate(api.key, 'tables', true)" uib-btn-radio="true">Yes</label>
                                        <label class="btn btn-default" ng-model="api.permissions.tables" ng-click="apiPermUpdate(api.key, 'tables', false)" uib-btn-radio="false">No</label>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <th>Delete()</th>
                                <td>
                                    <div class="btn-group">
                                        <label class="btn btn-default" ng-model="api.permissions.delete" ng-click="apiPermUpdate(api.key, 'delete', true)" uib-btn-radio="true">Yes</label>
                                        <label class="btn btn-default" ng-model="api.permissions.delete" ng-click="apiPermUpdate(api.key, 'delete', false)" uib-btn-radio="false">No</label>
                                    </div>
                                </td>
                                <th>Tags()</th>
                                <td>
                                    <div class="btn-group">
                                        <label class="btn btn-default" ng-model="api.permissions.tags" ng-click="apiPermUpdate(api.key, 'tags', true)" uib-btn-radio="true">Yes</label>
                                        <label class="btn btn-default" ng-model="api.permissions.tags" ng-click="apiPermUpdate(api.key, 'tags', false)" uib-btn-radio="false">No</label>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <th>Diff()</th>
                                <td>
                                    <div class="btn-group">
                                        <label class="btn btn-default" ng-model="api.permissions.diff" ng-click="apiPermUpdate(api.key, 'diff', true)" uib-btn-radio="true">Yes</label>
                                        <label class="btn btn-default" ng-model="api.permissions.diff" ng-click="apiPermUpdate(api.key, 'diff', false)" uib-btn-radio="false">No</label>
                                    </div>
                                </td>
                                <th>Upload()</th>
                                <td>
                                    <div class="btn-group">
                                        <label class="btn btn-default" ng-model="api.permissions.upload" ng-click="apiPermUpdate(api.key, 'upload', true)" uib-btn-radio="true">Yes</label>
                                        <label class="btn btn-default" ng-model="api.permissions.upload" ng-click="apiPermUpdate(api.key, 'upload', false)" uib-btn-radio="false">No</label>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <th>Download()</th>
                                <td>
                                    <div class="btn-group">
                                        <label class="btn btn-default" ng-model="api.permissions.download" ng-click="apiPermUpdate(api.key, 'download', true)" uib-btn-radio="true">Yes</label>
                                        <label class="btn btn-default" ng-model="api.permissions.download" ng-click="apiPermUpdate(api.key, 'download', false)" uib-btn-radio="false">No</label>
                                    </div>
                                </td>
                                <th>Views()</th>
                                <td>
                                    <div class="btn-group">
                                        <label class="btn btn-default" ng-model="api.permissions.views" ng-click="apiPermUpdate(api.key, 'views', true)" uib-btn-radio="true">Yes</label>
                                        <label class="btn btn-default" ng-model="api.permissions.views" ng-click="apiPermUpdate(api.key, 'views', false)" uib-btn-radio="false">No</label>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <th>Indexes()</th>
                                <td>
                                    <div class="btn-group">
                                        <label class="btn btn-default" ng-model="api.permissions.indexes" ng-click="apiPermUpdate(api.key, 'indexes', true)" uib-btn-radio="true">Yes</label>
                                        <label class="btn btn-default" ng-model="api.permissions.indexes" ng-click="apiPermUpdate(api.key, 'indexes', false)" uib-btn-radio="false">No</label>
                                    </div>
                                </td>
                                <th>Webpage()</th>
                                <td>
                                    <div class="btn-group">
                                        <label class="btn btn-default" ng-model="api.permissions.webpage" ng-click="apiPermUpdate(api.key, 'webpage', true)" uib-btn-radio="true">Yes</label>
                                        <label class="btn btn-default" ng-model="api.permissions.webpage" ng-click="apiPermUpdate(api.key, 'webpage', false)" uib-btn-radio="false">No</label>
                                    </div>
                                </td>
                            </tr>
                        </table>
                    </td>
                </tr>
                <tr ng-if="apiKeys === null">
                    <td colspan="3" style="text-align: center;">You don't have any API keys yet</td>
                </tr>
                <tr>
                    <td style="border-left: none;" colspan="4">
                        <div>
                            <div class="row" ng-if="statusMessage != ''">
                                <div style="text-align: center; padding-bottom: 8px;">
                                    <h4 style="color: {{ statusMessageColour }};">&nbsp;{{ statusMessage }}</h4>
                                </div>
                            </div>
                        </div>
                        <div style="text-align: center;">
                            <input type="submit" class="btn btn-primary" value="Generate new API key" ng-click="apiKeyGen()">
                        </div>
                    </td>
                </tr>
            </table>
        </div>
        <div class="col-md-1">
            &nbsp;
        </div>
    </div>
</div>
[[ template "footer" . ]]
<script>
    let app = angular.module('DBHub', ['ui.bootstrap', 'ngSanitize']);
    app.controller('prefView', function($scope, $http, $httpParamSerializerJQLike) {
        // API Keys
        $scope.apiKeys = [[ .APIKeys ]];

        // Database names
        $scope.dbList = [[ .DBNames ]];

        // Send the changed database selection to the backend
        $scope.changeDB = function(apiKey, newDB) {
            // Work out the "all databases" value to send
            let allDBs = false;
            if (newDB === "") {
                allDBs = true;
            }

            // Send the new database info to the backend
            $http({
                method: "POST",
                url: "/x/apikeydbupdate/",
                data: $httpParamSerializerJQLike({
                    "apikey": encodeURIComponent(apiKey),
                    "dbname": encodeURIComponent(newDB),
                    "alldbs": encodeURIComponent(allDBs),
                }),
                headers: { "Content-Type": "application/x-www-form-urlencoded" }
            }).then(function (response) {
                // Clear any error message
                $scope.statusMessageColour = "green";
                $scope.statusMessage = "";
            }, function failure(response) {
                $scope.statusMessageColour = "red";
                $scope.statusMessage = "Server message: " + response.data;
            });
        }

        // Select "all databases"
        $scope.allDBs = function(apiKey) {
            $scope.apiKeys[apiKey].database_name = "All databases";

            // Send the change to the backend
            $scope.changeDB(apiKey, "");
        }

        // Change the selected database
        $scope.selectDB = function(apiKey, newDB) {
            $scope.apiKeys[apiKey].database_name = newDB;

            // Send the change to the backend
            $scope.changeDB(apiKey, newDB);
        }

        // TODO: Add the API key revoking piece(s)
        $scope.apiKeyRevoke = function(apiKey) {
            // ...
        }

        // If the supplied display name is blank, we set a placeholder value instead
        $scope.FullName = "";
        $scope.NamePlaceholder = "";
        if ("[[ .DisplayName ]]" == "") {
            $scope.NamePlaceholder = "Jane Doe";
        } else {
            $scope.FullName = "[[ .DisplayName ]]";
        }

        // Same thing, but for email address
        $scope.EmailAddr = "";
        $scope.EmailPlaceholder = "";
        if ("[[ .Email ]]" == "") {
            $scope.EmailPlaceholder = "[[ .Meta.LoggedInUser ]]@[[ .Meta.Server ]]";
        } else {
            $scope.EmailAddr = "[[ .Email ]]";
        }

        // Auth0
        let lock = new Auth0Lock("[[ .Auth0.ClientID ]]", "[[ .Auth0.Domain ]]", { auth: {
            redirectUrl: "[[ .Auth0.CallbackURL]]"
        }});

        $scope.showLock = function() {
            lock.show();
        };

        // Send the updated permission to the backend
        $scope.apiPermUpdate = function(apiKey, perm, value) {
            $http({
                method: "POST",
                url: "/x/apikeypermupdate/",
                data: $httpParamSerializerJQLike({
                    "apikey": encodeURIComponent(apiKey),
                    "perm": encodeURIComponent(perm),
                    "value": encodeURIComponent(value)
                }),
                headers: { "Content-Type": "application/x-www-form-urlencoded" }
            }).then(function (response) {
                // Clear any error message
                $scope.statusMessageColour = "green";
                $scope.statusMessage = "";
            }, function failure(response) {
                $scope.statusMessageColour = "red";
                $scope.statusMessage = "Server message: " + response.data;
            });
        };

        // Generate a new API key
        $scope.statusMessage = "";
        $scope.statusMessageColour = "red";
        $scope.apiKeyGen = function() {
            // Call the backend to generate a new API key
            $http.get("/x/apikeygen").then(
                function success(response) {
                    $scope.statusMessageColour = "green";
                    $scope.statusMessage = "New API key '" + response.data["key"] + "' created";

                    // Append the new key to the displayed list
                    let newKey = {"key": response.data["key"], "date_created": response.data["date_created"]};
                    if ($scope.apiKeys !== null) {
                        $scope.apiKeys.push(newKey);
                    } else {
                        $scope.apiKeys = [newKey];
                    }

                }, function failure(response) {
                    // Key creation failed, so display the returned error message
                    $scope.statusMessageColour = "red";
                    $scope.statusMessage = "Creating new API key failed: " + response.data;
                }
            )
        };
    });
</script>
</body>
</html>
[[ end ]]
